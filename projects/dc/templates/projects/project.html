{% extends "projects/base.html" %}

{% load zwitschern %}
{% load i18n %}
{% load gravatar %}
{% load wiki %}
{% load wikiurl %}
{% load threadedcommentstags %}
{% load pagination_tags %}
{% load shorttimesince_tag %}
{% load extra_tagging_tags %}
{% load project_tags %}
{% load uni_form %}

{% block head_title %}{{ project.name }}{% endblock %}

{% block body %}
  <div>
   <div class = "skinny_column">
	<div class = "project_info">
        	<h1>{% trans "Project" %} {{ project.name }}</h1>

        	<p>
            		Slug: <tt>{{ project.slug }}</tt><br />
            		Creator: <a href="{% url profiles.views.profile project.creator.username %}">{{ project.creator }}</a><br />
            		Created: {{ project.created|date }}
            		<br />
            		{% show_tags_for project %}
        	</p>
	</div>

    {% if user.is_authenticated %}
            <div class="project_members">
                <h2>{% trans "Members" %}</h2>
                <div>
                    {% for member in project.members.all %}
                        {% if forloop.counter0|divisibleby:"3" %}<tr>{% endif %}
                        <span class="{% if member.away %}away{% else %}active{% endif %}-member">
                            <div class="avatar">{% gravatar member.user 40 %}</div>
                            <div class="details"><a href="{% url profiles.views.profile member.user.username %}" title="{{ member.user.username }}">{{ member.user.username }}</a></div>
                        </span>
                        {% if forloop.counter0|add:"1"|divisibleby:"3" %}</div>{% endif %}
                    {% endfor %}
                    {% if project.members.all|length|divisibleby:"3" %}{% else %}</div>{% endif %}
                </div>
            <!-- <p><a href="{% url project_members_status project.slug %}">Members' Status</a></p> -->
    {% endif %}	
	</div>
	
        <div class = "project_desc">
		<p>{{ project.description }}</p>

        	{% ifequal user project.creator %}
            		<p><a href="#" onclick="$('#project_form').toggle(); return false;">{% trans "Edit details" %}</a></p>

            		<form id="project_form" class="uniForm" method="POST" action="" style="display: none;">
                		<fieldset>
                    			{{ project_form|as_uni_form }}
                    			<div class = "form_block">
                        			<input type="hidden" name="action" value="update" />
                        			<input type="submit" value="{% trans 'update' %}"/>
                    			</div>
                		</fieldset>
            		</form>
            
        	{% endifequal %}

        	{% if user.is_authenticated %}
            		<div>
                		{% if are_member %}
                    			{% ifequal user project.creator %}
                        			<p>You are the creator of this project.</p>
                        			<p><a href="#" onclick="$('#adduser_form').toggle(); return false;">{% trans "Add new member" %}</a></p>
                        			<form id="adduser_form" class="uniForm" method="POST" action="" style="display: none;">
                         				<fieldset>
                               					{{ adduser_form|as_uni_form }}
                                				<div class = "form_block">
                                    					<input type="hidden" name="action" value="add" />
                                    					<input type="submit" value="{% trans 'add' %}"/>
                                				</div>
                            				</fieldset>
                        			</form>
                        			<p><img src="/site_media/delete.png" /> <a href="#" onclick="$('#delete_project_form').toggle(); return false;">{% trans "Delete project" %}</a><p>
                         			<form class="delete_form" id="delete_project_form" action="{% url project_delete project.slug %}" method="POST" style="display: none;">
                             				<input type="submit" value="{% trans "Delete Project" %}" /> (all content will be removed)
                        			</form>
                    			{% else %}
                        			<p>You are member of this project.</p>
                    			{% endifequal %}
                		{% else %}
                    			<p>It is up to the creator of this project (<a href="{% url profiles.views.profile project.creator.username %}">{{ project.creator }}</a>) to add you.</p>
                		{% endif %}
            		</div>
        	{% endif %}
	</div>

        {% if user.is_authenticated %}
		<div class = "project_tasks">
            		<h2>Tasks{% if total_tasks %} ({{ total_tasks }}){% endif %}</h2>

            		<p><a href="{% url project_tasks project.slug %}" method="Post">view more details or add task...</a></p>

            		<div class="tasks">
                		{% for task in tasks %}
                    			<div class="task_{{ task.get_state_display }} {% cycle odd,even %}">
                        			<span><a href="{% url project_task task.id %}">{{ task.summary }}</a></span>
                        			<span>{{ task.modified|shorttimesince }} ago</span>
                        			<span>
                            				{% if task.assignee %}
                                				{{ task.assignee }}
                            				{% else %}
                                				<span class="warning">unassigned</span>
                            				{% endif %}
                        			</span>
                        			<span>{{ task.status }}</span>
                    			</span>
                		{% endfor %}
            		</div>
		</div>
		<div class = "project_discussion">
            		<h2>Discussion Topics{% if project.topics.all.count %} ({{ project.topics.all.count }}){% endif %}</h2>

            		{% if topics %}
                		<p><a href="{% url project_topics project.slug %}">view more details or start new topic...</a></p>

                		{% for topic in topics %}
                    			{% show_project_topic topic %}
                		{% endfor %}
            		{% else %}
                		<p>None yet. <a href="{% url project_topics project.slug %}">Start one...</a></p>
            		{% endif %}
		</div>
		<div class = "project_wiki">
            		<h2>Wiki Articles{% if total_articles %} ({{ total_articles }}){% endif %}</h2>

            		{% if articles %}
                		<div class="topics">
                   			 {% for article in articles %}
                        			{% show_teaser article %}
                    			{% endfor %}
                		</div>
                		<p><a href="{% wikiurl list project %}">more...</a></p>
            		{% else %}
                		{% wikiurl list project as wiki_url %}
                		<p>
                    			{% blocktrans %}
                        			None yet. Go to the <a href="{{ wiki_url }}" title="wiki">wiki</a> to start a new article.
                    			{% endblocktrans %}
                		</p>
            		{% endif %}
		</div>
		<div class = "project_photos">
            		{% if photos %}
                		<h2>Project Photo Pool</h2>
                		<div class="thumb-row clearfix">
                    			{% for photo in photos %}
                    				<div class="gallery-photo-thumb">
                        				<a href="/photos/details/{{ photo.photo.id }}/"><img src="{{ photo.photo.get_thumbnail_url }}" alt="{{ photo.photo.title }}"/></a><br />
                        				<img src="/site_media/comment.png" border="0" class="noborder" align="absmiddle" /><a href="/photos/details/{{ photo.photo.id }}/">{% get_comment_count for photo.photo as commentcount %} {{ commentcount }} Comments</a>
                   				</div>
                   			{% endfor %}
               			</div>
            		{% endif %}
		</div>
            	{% comment %}
		<div class = "status">
                	<h2>{% trans "Tweets" %}</h2>

                	{% tweet_listing tweets 1 0 %}
		</div>
            	{% endcomment %}

        {% endif %}

         </div>


{% endblock %}

{% block extra_body %}
    {{ block.super }}
    <script type="text/javascript" src="/site_media/jquery.bgiframe.js"></script>
    <script type="text/javascript" src="/site_media/jquery.dimensions.js"></script>
    <script type="text/javascript" src="/site_media/jquery.ajaxQueue.js"></script>
    <script type="text/javascript" src="/site_media/jquery.autocomplete.js"></script>
    <script type="text/javascript">
        $().ready(function() {
            $("#id_recipient").autocomplete("{% url profile_username_autocomplete %}", {
                formatItem: function(data, i, n, value) {
                    values = value.split(",,");
                    return values[0] + values[1] + "<br />" + values[2];
                },
                formatResult: function(data, value) {
                    return value.split(",,")[1];
                },
                // TODO: improve highlighting to only affect username.
                highlight: false,
            });
            {% if project_form.errors %}
                $('#project_form').show();
            {% endif %}
            {% if adduser_form.errors %}
                $('#adduser_form').show();
            {% endif %}
        });
    </script>
{% endblock %}
