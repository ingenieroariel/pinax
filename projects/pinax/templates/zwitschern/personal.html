{% extends "zwitschern/base.html" %}

{% load i18n %}

{% block head_title %}Pinax : {% blocktrans %}Tweets{% endblocktrans %}{% endblock %}

{% block body %}
<h1>{% trans "Tweets" %}</h1>

<form method="POST" action="{% url zwitschern.views.personal %}">
    <p>{% trans "What are you doing?" %}</p>
    <textarea id="new_tweet" name="tweet" cols="30" rows="4">{% if reply %}@{{ reply }} {% endif %}</textarea>
    <p><span id="chars_left"></span> {% trans "chars left." %} <input type="hidden" name="action" value="post" /><input type="submit" value="{% trans "post" %}"></p>
    
</form>

<p>{% blocktrans with user.followed.count as follow_count and user.followed.count|pluralize:"person,people" as follow_name %}
These are tweets from the {{ follow_count }} {{ follow_name }} you are following (plus your own){% endblocktrans %}:</p>

{% for tweet in tweets %}
<div class="tweet">
<a href="{% url profiles.views.profile tweet.sender %}"><b>{{ tweet.sender }}</b></a>
{{ tweet.html|safe }}
<span class="timesince">{% blocktrans with tweet.sent|timesince as tweet_age %}
{{ tweet_age }} ago{% endblocktrans %}</span>
<a class="reply" href="{% url zwitschern.views.personal %}?reply={{ tweet.sender }}">{% trans "reply" %}</a>
</div>
{% endfor %}

{% endblock %}

{% block extra_body %}

<script>
    $(document).ready(function() {
        function update_chars_left() {
            var max_len = 140;
            var textarea = $('#new_tweet')[0];
            var tweet_len = textarea.value.length;
            if (tweet_len >= max_len) {
                textarea.value = textarea.value.substring(0, max_len); // truncate
                $('#chars_left').html("0");
            } else {
                $('#chars_left').html(max_len - tweet_len);
            }
        }
        $('#new_tweet').keyup(function() {
            update_chars_left();
        });
        update_chars_left();
        $('#new_tweet').focus();
        {% if reply %}
        var offset = {{ reply|length }} + 2;
        var textarea = $('#new_tweet')[0];
        if (textarea.setSelectionRange) { // Safari, Firefox
            textarea.setSelectionRange(offset, offset);
        } else if (textarea.createTextRange) { // IE
            var range = textarea.createTextRange();
            range.collapse(true);
            range.moveEnd('character', offset);
            range.moveStart('character', offset);
            range.select();
        }
        {% endif %}
    });
</script>

{% endblock %}